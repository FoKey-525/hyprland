const u={isInitialized:!1,paywallId:null,_initPromise:null,_eventHandlers:new Map,_paywallDocumentRoot:null,_observer:null,_overrideStyles:null,init:function(a,t,n){return console.log("init"),this._initPromise||(this.paywallId=a,this._paywallDocumentRoot=n??document,this._initPromise=new Promise(i=>{this._addEventHandler("init",e=>{e.data.type==="state"&&e.data.state.hasOwnProperty("visibility_status")&&(this.isInitialized=!0,this._removeEventHandler("init"),i(!0))}),window.addEventListener("message",this._globalEventHandler.bind(this),!1),this._createAndAppendIframe()})),this._initPromise},_createAndAppendIframe:function(){window.requestAnimationFrame(()=>{let a=()=>{let t=this._paywallDocumentRoot.createElement("iframe");t.src="https://onlineapp.pro/paywall/".concat(this.paywallId,"?v=2"),t.id="paywall-".concat(this.paywallId),t.style.display="none";let n=this._paywallDocumentRoot.body||this._paywallDocumentRoot;n?n.appendChild(t):console.warn("[PAYWALL ERROR] Paywall container not found")};this._paywallDocumentRoot.readyState==="loading"?this._paywallDocumentRoot.addEventListener("DOMContentLoaded",a):a()})},_globalEventHandler:function(a){let t=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId));if(a.source===t?.contentWindow)for(let[n,i]of(a.data.type==="change-styles"?Object.assign(t.style,{...a.data.style,...this._overrideStyles||{}}):a.data.type==="redirect"?window.open(a.data.redirectUrl):a.data.type==="remove"&&t.remove(),this._eventHandlers))i(a)},_addEventHandler:function(a,t){this._eventHandlers.set(a,t)},_removeEventHandler:function(a){this._eventHandlers.delete(a)},_ensureInitialized:async function(){this.isInitialized||await this._initPromise},open:async function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{resolveEvent:"opened",paywallContainerId:void 0};return await this._ensureInitialized(),new Promise((t,n)=>{var i;if(this._addEventHandler("open",e=>{var s;if(((s=e.data)===null||s===void 0?void 0:s.type)==="state"&&["https://onlineapp.pro","https://onlineapp.live","https://onlineapp.stream"].includes(e.origin))if(e.data.state.visibility_status==="invisible"&&e.data.state.purchase_status!=="paid"&&e.data.state.visibility_status_reason!=="tokenization-sign-in")this._removeEventHandler("open"),n(e.data.state);else switch(a.resolveEvent){case"opened":e.data.state.visibility_status==="visible"&&(this._removeEventHandler("open"),t(e.data.state));break;case"signed-in":e.data.state.auth_status==="signed-in"&&(this._removeEventHandler("open"),t(e.data.state));break;case"success-purchase":e.data.state.purchase_status==="paid"&&(this._removeEventHandler("open"),t(e.data.state))}}),a?.paywallContainerId){let e=this._paywallDocumentRoot.getElementById(a.paywallContainerId);e?this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId))?(this._updateIframeStyles(e),new ResizeObserver(()=>{this._updateIframeStyles(e)}).observe(e)):console.warn("[PAYWALL ERROR] Paywall iframe not found"):console.warn("[PAYWALL ERROR] Specified container not found")}(i=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId)))===null||i===void 0||i.contentWindow.postMessage({action:"open"},"*")})},_updateIframeStyles:function(a){let t=a.getBoundingClientRect(),n=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId));this._overrideStyles={position:"absolute",top:"".concat(t.top+window.scrollY,"px"),left:"".concat(t.left+window.scrollX,"px"),width:"".concat(t.width,"px"),height:"".concat(t.height,"px")},n?(n.style.position="absolute",n.style.top="".concat(t.top+window.scrollY,"px"),n.style.left="".concat(t.left+window.scrollX,"px"),n.style.width="".concat(t.width,"px"),n.style.height="".concat(t.height,"px")):console.warn("[PAYWALL ERROR] Paywall iframe not found")},renew:async function(){return await this._ensureInitialized(),new Promise((a,t)=>{var n;this._addEventHandler("renew",i=>{var e;((e=i.data)===null||e===void 0?void 0:e.type)==="state"&&["https://onlineapp.pro","https://onlineapp.live","https://onlineapp.stream"].includes(i.origin)&&(i.data.state.purchase_status==="paid"?(this._removeEventHandler("renew"),a(i.data.state)):i.data.state.visibility_status_reason==="closed-by-user"&&(this._removeEventHandler("renew"),t(i.data.state)))}),(n=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId)))===null||n===void 0||n.contentWindow.postMessage({action:"renew"},"*")})},getUser:async function(){return await this._ensureInitialized(),this.makeRequest("https://onlineapp.pro/api/v1/paywall/".concat(this.paywallId,"/user"))},signOut:async function(){return await this._ensureInitialized(),this.makeRequest("https://onlineapp.pro/api/signout",{method:"POST"})},makeRequest:async function(a,t,n){return await this._ensureInitialized(),new Promise((i,e)=>{let s=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId)),o=Date.now();this._addEventHandler("request_".concat(o),l=>{l.data.requestId===o&&(this._removeEventHandler("request_".concat(o)),l.data.error?e(l.data.error):i(l.data.response))}),s?.contentWindow.postMessage({type:"MAKE_REQUEST",url:a,options:t,requestId:o},"*"),n&&(n.abort=()=>{this._abortRequest(o)})})},makeStreamRequest:async function*(a,t,n){await this._ensureInitialized();let i=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId)),e=Date.now();this._addEventHandler("stream_".concat(e),s=>new Promise((o,l)=>{if(s.data.requestId===e){var r,d;!((d=s.data)===null||d===void 0||(r=d.data)===null||r===void 0)&&r.error?l(s.data.data.error):o({chunk:s.data.chunk,done:s.data.done})}else o(null)})),i?.contentWindow.postMessage({type:"MAKE_STREAM_REQUEST",url:a,options:t,requestId:e},"*"),n&&(n.abort=()=>{this._abortRequest(e)});try{for(;;){let s=await new Promise((o,l)=>{let r=d=>{if(d.data.requestId===e){var p,c;!((c=d.data)===null||c===void 0||(p=c.data)===null||p===void 0)&&p.error?l(d.data.data.error):o(d.data)}};this._addEventHandler("stream_message_".concat(e),r)});if(s.done)break;s.chunk&&(yield s.chunk)}}finally{this._removeEventHandler("stream_".concat(e)),this._removeEventHandler("stream_message_".concat(e))}},_abortRequest:function(a){var t;let n=this._paywallDocumentRoot.getElementById("paywall-".concat(this.paywallId));n==null||(t=n.contentWindow)===null||t===void 0||t.postMessage({type:"ABORT_REQUEST",requestId:a},"*")}};export{u as paywall};
