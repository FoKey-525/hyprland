/*
FunPay Lite Bot
Copyright (c) 2022-2024 Leonid Tsaruk aka NightStranger
Source b.js
Build b92eb51a-59ae-4af0-a7e2-364c0dd4e7da
*/
(()=>{async function lt(t,e){chrome.runtime.getPlatformInfo(),e({farewell:!0})}var N=lt;async function mt(t,e){e({farewell:!0})}var M=mt;async function ft(t,e){chrome.runtime.reload(),e({farewell:!0})}var I=ft;function gt(t,e,r){switch(t.greeting){case"ping":return N(t,r),!0;case"saveSettings":return M(t,r),!0;case"onResetSettings":return I(t,r),!0}}var R=gt;function pt(){return"funpay.com"}var F=pt;function dt(){return`https://${F()}`}var m=dt;function ht(){let t=m();chrome.tabs.create({url:`${t}/lite`})}var O=ht;async function wt(t){let e=await chrome.storage.local.get(t);return chrome.runtime.lastError?chrome.runtime.lastError:t==null?e:e[t]}var d=wt;async function yt(){return await d(null)}var l=yt;async function xt(){let t=await l();if(!t.appData)throw new Error("App data is not set.");return t.appData}var y=xt;async function St(){return(await l()).tgUsername}var x=St;var S={debug:!1};function Ut(){return S.debug?"localhost:3000":"api.litefor.fun"}var b=Ut;function Dt(){return S.debug?`http://${b()}`:`https://${b()}`}var L=Dt;async function $t(t){let r=new TextEncoder().encode(t),o=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(o)).map(n=>n.toString(16).padStart(2,"0")).join("")}var k=$t;async function Ct(){try{let t=await l(),e=await y(),r=chrome.runtime.getManifest().version,o=e.userId,s=e.userName,a=await x(),n=t.autoUp,u=t.customNotify,c=t.customPrices,f=t.hideBalance,P=t.theme,C=Date.now(),T={v:r,u:o,n:s,t:a,a:n,j:u,k:c,h:f,c:P,g:C,b:""},rt=await k(JSON.stringify(T));T.b=rt;let _=Math.floor(Math.random()*25)+1,ot=JSON.stringify(T).split("").map(ut=>String.fromCharCode(ut.charCodeAt(0)+_)).join(""),nt=btoa(unescape(encodeURIComponent(ot))),at=btoa(unescape(encodeURIComponent(_.toString()))),st=`${nt}.${at}`,it={method:"POST",headers:{"Content-Type":"text/plain"},body:st},ct=L(),A=(await fetch(`${ct}/api/v1/r`,it)).headers.get("X-R");return A?Number(A):null}catch{return null}}var j=Ct;function Tt(t){return new Promise(e=>setTimeout(e,t))}var p=Tt;async function bt(){let e=12e4;for(;;){let r=await j();!r||isNaN(r)?e=12e4:e=r,await p(e)}}var V=bt;function vt(){V(),setInterval(chrome.runtime.getPlatformInfo,2e4)}var B=vt;async function Et(){B(),chrome.runtime.onMessage.addListener((t,e,r)=>R(t,e,r)),chrome.action.onClicked.addListener(()=>O())}var q=Et;function Pt(t,e=!1){let r=new Date,o=r.getDate().toString(),s=(r.getMonth()+1).toString(),a=r.getFullYear().toString(),n=r.getHours().toString(),u=r.getMinutes().toString(),c=r.getSeconds().toString();o.toString().length==1&&(o=`0${o}`),s.toString().length==1&&(s=`0${s}`),n.toString().length==1&&(n=`0${n}`),u.toString().length==1&&(u=`0${u}`),c.toString().length==1&&(c=`0${c}`);let f=`>[${o}.${s}.${a}] [${n}:${u}:${c}] >LB: ${t}`;e?console.error(f):console.log(f),typeof t=="object"&&console.log(t)}var i=Pt;var H=500,_t=7,v=0;async function At(t,e={},r=_t){try{let o=null,s=0,a=0,n=Date.now();for(n-v<H&&(a=H-(n-v)),v=n+a;s<r;){await p(a),s++;try{if(o=await fetch(t,e),o.status===429)throw new Error("Too many requests");break}catch(u){console.log(u),a=a*2}}return o}catch(o){i(`Error while fetch: ${o}`)}}var g=At;async function Nt(t,e){try{let o=`${m()}/lots/raise`,s=new URLSearchParams;s.append("game_id",t),s.append("node_id",e);let a={accept:"*/*","content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest"},n={method:"POST",body:s,headers:a},u=await g(o,n),c=await u.json();if(c.modal){let f=new RegExp('value="(.*?)"',"g");[...c.modal.matchAll(f)].forEach(C=>{s.append("node_ids[]",C[1])}),n={method:"POST",body:s,headers:a},u=await g(o,n),c=await u.json()}return{success:!0,msg:c.msg}}catch(r){return i(`Error while raising lot: ${r}`),{success:!1}}}var E=Nt;function Mt(t){let e=/\d+/,r=Number(t.match(e));return isNaN(r)||r==0?null:r}var G=Mt;function It(t){let r=new Date().getTime();if(!t)return r+6e4;if(typeof t=="number")return r+t;let o={en:{hour:"hour",minute:"minute",second:"second"},ru:{hour:"час",minute:"минут",second:"секунд"},uk:{hour:"годин",minute:"хвилин",second:"секунд"}},s=[{unit:"hour",multiplier:36e5,fallback:18e5},{unit:"minute",multiplier:6e4,fallback:6e4},{unit:"second",multiplier:1e3,fallback:3e4}];for(let a in o)for(let{unit:n,multiplier:u,fallback:c}of s)if(t.includes(o[a][n])){let f=G(t);return f==null?r+c:r+(f-(n==="hour"?1:0))*u}return r+6e4}var U=It;async function Rt(t,e,r=!1){let o={};return r?o=e:o[t]=e,await chrome.storage.local.set(o),chrome.runtime.lastError?chrome.runtime.lastError:!0}var D=Rt;async function Ft(){try{let t=await d("userCategories");if(!t||!t.length)throw new Error("No categories found");for(let e=0;e<t.length;e++){if(t[e].time||(t[e].time=0),Date.now()<t[e].time)continue;let o=await E(t[e].game_id,t[e].node_id);if(!o.success){i(`Cannot raise lot '${t[e].node_name} ${t[e].game_name}': ${o.msg}`),t[e].time=U("");continue}["Подождите","Please wait","Зачекайте"].some(n=>o.msg.includes(n))&&(t[e].time=U(o.msg),i(`Lots in categoty '${t[e].node_name} ${t[e].game_name}' is too early to up. Next try: ${o.msg} / ${t[e].time} / ${new Date(t[e].time).toString()}`)),["подняты","raised","підняті"].some(n=>o.msg.includes(n))&&(o=await E(t[e].game_id,t[e].node_id),t[e].time=U(o.msg),i(`Lots in categoty '${t[e].node_name} ${t[e].game_name}' upped successfully. Next up: ${o.msg} / ${t[e].time} / ${new Date(t[e].time).toString()}`))}await D("userCategories",t)}catch(t){i(`Error while raising lots if time: ${t}`)}}var J=Ft;async function Ot(t){return"getContexts"in chrome.runtime?!!(await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[t]})).length:(await self.clients.matchAll()).some(o=>o.url.includes(chrome.runtime.id))}var K=Ot;var X="offscreen/offscreen.html",w=null;async function Lt(){let t=chrome.runtime.getURL(X);return await K(t)?!1:(w?await w:(w=chrome.offscreen.createDocument({url:X,reasons:["DOM_PARSER"],justification:"Needs to parse DOM and extract information"}),await w,w=null),!0)}var h=Lt;async function kt(){try{let t={method:"GET"},e=m(),r=await y(),s=await(await g(`${e}/users/${r.userId}/`,t)).text();return await h(),await chrome.runtime.sendMessage({target:"offscreen",method:"parseAllUserCategories",payload:{html:s}})}catch(t){console.log(`Error while getting categories: ${t}`)}}var Y=kt;async function jt(){try{let t=m(),o=await(await g(t,{method:"GET"})).text();return await h(),await chrome.runtime.sendMessage({target:"offscreen",method:"parseAllFunPayCategories",payload:{html:o}})}catch(t){throw new Error(`Error while getting all categories: ${t}`)}}var z=jt;async function Vt(t){return await D(null,t,!0)}var $=Vt;async function Bt(){try{i("Updating list of categories...");let t=await l(),e=await Y();if(!e||e.length==0)return;let r=await z();if(!r||r.length==0)return;let s=Object.assign(r.filter(a=>e.includes(a.node_id)&&a.type==="lots")).filter((a,n,u)=>n===u.findIndex(c=>c.node_id===a.node_id&&c.game_id===a.game_id&&c.type===a.type));if(t.userCategories)for(let a=0;a<t.userCategories.length;a++){let n=t.userCategories[a],u=s.findIndex(c=>c.node_id===n.node_id&&c.game_id===n.game_id);u!==-1&&n.time&&(s[u].time=Number(n.time))}t.userCategories=s,t.allFunPayCategoriesData=r,await $(t),i("List of categories updated."),i(t.userCategories)}catch(t){throw i(`Error while updateUserCategoriesData. ${t}`),new Error(`Error while updateUserCategoriesData. ${t}`)}return!0}var Q=Bt;async function qt(){let e=0;for(;;){if(!await d("autoUp")){await p(5e3);continue}Date.now()-e>12e4&&(i("updateUserCategoriesData tick"),await Q(),e=Date.now()),i("AutoUp tick"),await J(),await p(5e3)}}var W=qt;async function Ht(){try{let e=`${m()}/account/settings`,o=await(await g(e)).text();return await h(),await chrome.runtime.sendMessage({target:"offscreen",method:"parseTelegramUsername",payload:{html:o}})}catch(t){i(t)}}var Z=Ht;async function Gt(t){let e=await l();e.tgUsername=t,await $(e)}var tt=Gt;async function Jt(){if(i("App started"),!await l())return;if(!await x()){let r=await Z();r&&await tt(r)}W()}var et=Jt;q();et();})();
