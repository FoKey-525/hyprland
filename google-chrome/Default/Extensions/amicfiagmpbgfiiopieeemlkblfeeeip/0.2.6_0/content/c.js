/*
FunPay Lite Bot
Copyright (c) 2022-2024 Leonid Tsaruk aka NightStranger
Source c.js
Build b92eb51a-59ae-4af0-a7e2-364c0dd4e7da
*/
(()=>{function ie(e,t=!1){let o=new Date,r=o.getDate().toString(),n=(o.getMonth()+1).toString(),a=o.getFullYear().toString(),s=o.getHours().toString(),c=o.getMinutes().toString(),l=o.getSeconds().toString();r.toString().length==1&&(r=`0${r}`),n.toString().length==1&&(n=`0${n}`),s.toString().length==1&&(s=`0${s}`),c.toString().length==1&&(c=`0${c}`),l.toString().length==1&&(l=`0${l}`);let g=`>[${r}.${n}.${a}] [${s}:${c}:${l}] >LB: ${e}`;t?console.error(g):console.log(g),typeof e=="object"&&console.log(e)}var i=ie;async function ae(e){let t=await chrome.storage.local.get(e);return chrome.runtime.lastError?chrome.runtime.lastError:e==null?t:t[e]}var h=ae;async function ce(){return await h(null)}var S=ce;async function se(e,t,o=!1){let r={};return o?r=t:r[e]=t,await chrome.storage.local.set(r),chrome.runtime.lastError?chrome.runtime.lastError:!0}var B=se;async function le(e){return await B(null,e,!0)}var w=le;function ue(){try{let e=document.querySelector(".user-link-name");return e?e.textContent:null}catch(e){return i(`Error while getUserName: ${e}`),null}}var M=ue;function me(){try{let e=document.querySelector("body");if(!e)return null;let o=e.dataset.appData;return o?JSON.parse(o):null}catch(e){return i(`Error while getBodyAppData: ${e}`),null}}var F=me;function fe(){try{let e=F(),t=M();return{userId:e.userId,userName:t,csrfToken:e["csrf-token"]}}catch(e){return i(`Error while getAppData: ${e}`),null}}var N=fe;function pe(e){if(!e||e.includes("₽"))return"RUB";if(e.includes("$"))return"USD";if(e.includes("€"))return"EUR"}var $=pe;function de(e){return new Promise(t=>setTimeout(t,e))}var b=de;var k=500,ge=7,L=0;async function he(e,t={},o=ge){try{let r=null,n=0,a=0,s=Date.now();for(s-L<k&&(a=k-(s-L)),L=s+a;n<o;){await b(a),n++;try{if(r=await fetch(e,t),r.status===429)throw new Error("Too many requests");break}catch(c){console.log(c),a=a*2}}return r}catch(r){i(`Error while fetch: ${r}`)}}var D=he;function ye(){return"funpay.com"}var q=ye;function Se(){return`https://${q()}`}var E=Se;async function we(e,t,o="RUB"){try{if(t>1e3&&(o=="USD"||o=="EUR"))throw new Error("Cannot get minimum price for USD or EUR currency with price more than 1000.");let r=new URLSearchParams;r.append("nodeId",e.toString()),r.append("price",t);let n={method:"POST",body:r,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json, text/javascript, */*; q=0.01","X-Requested-With":"XMLHttpRequest"}},a=E(),l=(await(await D(`${a}/lots/calc`,n)).json()).methods;if(!l||l.length==0)return;for(let f=0;f<l.length;f++){let m=l[f];m.priceString=m.price.replace(" ",""),m.price=Number(m.priceString)}let g=1e9;for(let f=0;f<l.length;f++){let m=l[f];$(m.unit)==o&&m.price<g&&(g=m.price)}return g}catch(r){throw new Error(`Error in getCategoryMinPrice: ${r}`)}}var U=we;async function be(e,t="RUB"){let o=1e5;t!=="RUB"&&(o=1e3);let r=await U(e,o,t);return(r-o)/r*100}var H=be;function Ee(){let e=document.querySelector(".form-control-feedback");if(!e)return"RUB";let t=e.textContent;if(!t||t.includes("₽"))return"RUB";if(t.includes("$"))return"USD";if(t.includes("€"))return"EUR"}var I=Ee;function ve(e,t){let o=e*(1-t/100);return Math.round(o*1e3)/1e3}var v=ve;function Le(e,t){let o=e/(1-t/100);return Math.round(o*100)/100}var R=Le;function Te(){let e=document.querySelector(".js-buyer-price"),t=document.querySelector(".js-seller-price"),o=Number(t.dataset.comission);if(!o)return;let r=Number(t.value),n=R(r,o).toString();e.value=n,e.setAttribute("value",n)}var A=Te;function Ce(){let e=document.querySelector(".js-buyer-price"),t=document.querySelector(".js-seller-price"),o=Number(e.dataset.comission);if(!o)return;let r=Number(e.value),n=v(r,o).toString();t.value=n,t.setAttribute("value",n);let a=new Event("input");t.dispatchEvent(a)}var j=Ce;async function xe(){let e=Number(document.location.search.split("&")[0].split("=")[1]);if(isNaN(e))return 0;let t=document.querySelector('input[name="price"]');if(!t)return;let o=t.parentElement,r=o.cloneNode(!0),n=r.querySelector('input[name="price"]');t.classList.add("js-seller-price"),t.addEventListener("input",Be),n.name="",n.classList.add("js-buyer-price"),n.addEventListener("input",Pe);let a=o.querySelector(".control-label");a.textContent=`${a.textContent} (для продавца)`;let s=r.querySelector(".control-label");s.textContent=`${s.textContent} (для покупателя)`,o.after(r);let c=await H(e,I());if(i(`Category comission: ${c}`),!c)return;t.dataset.comission=c,n.dataset.comission=c;let l=Number(t.value);n.value=v(l,c).toString(),i("CustomPrice is loaded.")}function Pe(e){j()}function Be(e){e.isTrusted&&A()}var O=xe;function Me(){document.title=="429 Too Many Requests"&&setTimeout(()=>window.location.reload(),400)}var V=Me;async function Fe(){V();let e=await S(),t=N();t&&(e.appData=t,w(e));let o=document.location.pathname;e.customPrices==!0&&o.includes("/offerEdit")&&(O(),i("CustomPrices is working."))}var T=Fe;function Ne(){chrome.runtime.sendMessage({greeting:"ping"}),document.readyState==="complete"||document.readyState==="interactive"?T():document.addEventListener("DOMContentLoaded",()=>T())}var W=Ne;function $e(){return chrome.i18n.getMessage("extSmallName")}var p=$e;async function ke(e){return new Promise((t,o)=>{let r=document.querySelector("html");if(!r)return o("No target found");let n=new MutationObserver((s,c)=>{let l=document.querySelector(e);l&&(c.disconnect(),t(l))}),a=document.querySelector(e);if(a)return t(a);n.observe(r,{childList:!0,subtree:!0})})}var u=ke;async function De(){try{let e=E(),t=await u("ul[class = 'nav navbar-nav navbar-right logged']"),o=document.createElement("li"),r=p();o.innerHTML=`<a style="/*color: #2997b7;*/ font-weight: bold; cursor: pointer; user-select: none;" onclick='document.location.replace("${e}/lite")'>${r}</a>`,t&&t.prepend(o)}catch(e){i(`Ошибка при загрузке кнопки: ${e}`)}}var _=De;function qe(e){let t=document.querySelector(".wrapper"),o=document.querySelector(".notification");o?.remove(),o=document.createElement("div"),o.classList.add("ajax-alert"),o.classList.add("ajax-alert-info"),o.classList.add("notification"),o.classList.add("anim-out"),o.innerHTML=e,t&&t.after(o),setTimeout(()=>{o.remove()},2e3)}var C=qe;async function Ue(e,t,o){let r={};for(let a=0;a<e.length;a++){let s=e[a].name;r[s]=e[a].checked}r.theme=t.value;let n=await w(r);await chrome.runtime.sendMessage({greeting:"saveSettings"}),n?C(chrome.i18n.getMessage("settingsSaved")):C(chrome.i18n.getMessage("settingsNotSaved"))}var x=Ue;function He(e){let t=e.split("{");for(var o=1;o<t.length;o++){let r=t[o].split("}")[0];if(r.includes(" "))continue;let n=chrome.i18n.getMessage(r);n&&(e=e.replace(`{${r}}`,n))}return e}var G=He;function Ie(){let e=document.querySelectorAll(".js-question");for(let t=0;t<e.length;t++)e[t].src=chrome.runtime.getURL("assets/question.png")}var z=Ie;async function Re(e){let t=document.querySelectorAll(".theme");for(let o=0;o<t.length;o++)t[o].remove();if(e){let o=document.lastElementChild;if(!o)return;let r=document.createElement("style");r.classList.add("theme"),r.innerHTML=localStorage.getItem("LBThemeCSS")||"",o.appendChild(r)}else localStorage.removeItem("LBThemeCSS")}var P=Re;async function Ae(e){let t=chrome.runtime.getURL(e);return await(await fetch(t)).text()}var d=Ae;async function je(e){let t=e.target,o=null;if(t){switch(t.value){case"dark":o="content/static/themes/dark.css";break;case"firewatch":o="content/static/themes/firewatch.css";break;default:o=null;break}if(o==null)P(!1);else{let r=await d(o);localStorage.setItem("LBThemeCSS",r),P(!0)}}}var X=je;async function Oe(){localStorage.removeItem("LBThemeCSS"),localStorage.removeItem("LBThemeCSSSupport"),await chrome.storage.local.clear(),await chrome.runtime.sendMessage({greeting:"onResetSettings"})}var J=Oe;async function Ve(){confirm(chrome.i18n.getMessage("resetSettingsConfirm"))==!0&&(await J(),window.location.reload())}var Y=Ve;async function We(e,t){let o=await S();for(let r=0;r<e.length;r++){let n=e[r].name;o[n]==!0?e[r].checked=!0:e[r].checked=!1}o.theme||(o.theme="light"),t.value=o.theme}var K=We;function _e(e){setInterval(()=>{e.innerHTML=="Страница не найдена / FunPay"&&(e.innerHTML=p())},100)}var Q=_e;async function Ge(){ze(),Xe(),await Je();let e=document.querySelectorAll(".LB"),t=document.querySelector(".js-theme-select");if(!t)return;K(e,t);for(let r=0;r<e.length;r++)e[r].addEventListener("input",n=>x(e,t,n));t.addEventListener("input",r=>X(r)),t.addEventListener("input",r=>x(e,t,r));let o=document.querySelector(".js-settings-reset");o&&o.addEventListener("click",()=>Y())}async function ze(){try{let e=await u("title");return e&&!e.innerHTML.includes("429")&&(e.innerHTML=p()),Q(e),e}catch(e){return i("Error in loadDocumentTitle:",!0),i(e),null}}async function Xe(){let e=await u(".page-header"),t=chrome.runtime.getManifest().version;e&&(e.innerHTML=`<span>${p()}</span><span class="LB-version">v${t} (beta)</span><div class="lb-social footer-block-social"><a class="btn btn-gray btn-round" href="${chrome.i18n.getMessage("socialLinkTelegram")}" target="_blank" rel="nofollow"><i class="fab fa-telegram"></i></a><!--<a class="btn btn-gray btn-round" href="${chrome.i18n.getMessage("socialLinkDiscord")}" target="_blank" rel="nofollow"><i class="fab fa-discord"></i></a>--></div>`)}async function Je(){let e=localStorage.getItem("LBPageHTMLCache"),t="";e?t=e:t=await d("content/static/litebotpage/main.html");let o=await u(".lead");t=G(t),o&&(o.innerHTML=t,o.style.display="block"),z(),Ye()}async function Ye(){let e=await d("content/static/litebotpage/main.html");localStorage.setItem("LBPageHTMLCache",e)}var Z=Ge;async function Ke(){try{if(document.location.pathname.includes("/account/balance")){let t=document.querySelectorAll(".balances-value");for(let o=0;o<t.length;o++)t[o].innerHTML="???"}let e=await u(".badge-balance");e.dataset.balance=e.value,e.innerHTML=e.innerHTML.replace(/\d/g,"?")}catch(e){i(`Error while hiding balance: ${e}`)}}var ee=Ke;var Qe="https://nightssoftware.github.io";async function Ze(){try{let e=`${Qe}/storage/FPLiteBot/media/vk.mp3`,t=await u("source[src='/audio/chat_loud.mp3']"),o=document.querySelector("audio.loud");t.src=e,o.src=e}catch(e){i(`Ошибка при замене звука оповещения: ${e}`)}}var te=Ze;async function et(){_(),tt(),document.location.pathname=="/lite"&&Z(),ot()}async function tt(){await h("hideBalance")==!0&&(ee(),i("HideBalance is working."))}async function ot(){await h("customNotify")==!0&&(te(),i("ReplaceNotifySound is working."))}var oe=et;async function rt(e){let t=document.createElement("style");if(t.classList.add("theme"),t.innerHTML=e,new MutationObserver((n,a)=>{for(let s of n)if(s.type==="childList"){let c=document.head;c&&(c.appendChild(t),a.disconnect())}}).observe(document.documentElement,{childList:!0}),!document.querySelector(".theme")){let n=document.head;for(;!n;)await b(1),n=document.head;n.appendChild(t)}}var y=rt;function nt(){let e=localStorage.getItem("LBThemeCSS");e&&y(e)}var re=nt;async function it(){let{theme:e}=await chrome.storage.local.get("theme");if(e!=="light"){let t=localStorage.getItem("LBThemeCSSSupport");t||(t=await d("content/static/themes/dark_support.css"),localStorage.setItem("LBThemeCSSSupport",t)),y(t)}else localStorage.removeItem("LBThemeCSSSupport"),y("")}var ne=it;at();async function at(){document.location.host==="funpay.freshdesk.com"?await ne():(re(),W(),oe())}})();
